---
Difficulty: ???
Importance: ???
Added value: ???
Interest: ???
Sources:
  - https://lwn.net/Articles/252125/
  - https://stackoverflow.com/questions/11105827/what-is-a-store-buffer
  - https://developer.arm.com/documentation/den0024/a/Memory-Ordering
  - https://developer.arm.com/documentation/100941/0101/Memory-types
tags:
  - buffer
  - cpu
  - arm
  - combined
cssclasses:
  - ???
series:
  -  processor-components
categories:
  -  processor-components
date: 2024-08-18

---

## מבוא

בגלל שלקריאה וכתיבה לזיכרון חיצוני עלולה להיות זמן השהייה ממושך, מעבדים יכולים לצמצם את מספר ההעברות על ידי מיזוג מספר כתיבות (stores) לטרנזקציה אחת גדולה יותר. על ידי כך, המעבד מבצע את הכתיבות כפעולה אחת מרוכזת, מה שמפחית את העומס על ה-bus ושיפור היעילות של הגישה לזיכרון החיצוני.

שילוב כתיבה הוא אופטימיזציה שמטרתה לצמצם את כמות ההעברות בין ה-cache למכשירים, במיוחד במצבים שבהם עלויות ההעברה גבוהות משמעותית מהגישה המקומית ל-RAM. לדוגמה, בכרטיסים גרפיים, שעלויות ההעברה למכשירים גבוהות הרבה יותר. לכן, יש להימנע מהעברות מיותרות. אם יש צורך להעביר שורת cache שלמה רק בגלל שכתיבה אחת שונתה, זו פעולה בזבזנית, במיוחד אם הפעולה הבאה משנה מילה נוספת באותה השורה. בהתאם לכך, שילוב כתיבה אוסף מספר שינויים לפני שכותב את שורת ה-cache למכשיר. במצבים אידיאליים, כל מילה בשורת ה-cache משתנה אחת אחרי השנייה ורק לאחר שהמילה האחרונה השתנתה, שורת ה-cache נכתבת למכשיר.

כתיבה משולבת (write-combining) היא טכניקת אופטימיזציה שמאגדת מספר שינויים ומבצעת אותם רק לאחר מספר גישות לכתיבה, כלומר, מחסלת את התקורה הכרוכה בהעברות רבות לכל שינוי בודד של שורת ה-cache. טכניקה זו מיישמת כתיבה דחויה, כך שכתיבה מתבצעת רק לאחר מספר כתיבות (ובמקרה האידיאלי, לאחר הכתיבה האחרונה של השינוי), ואז מעבירה את השינויים לזיכרון הראשי. זהו נוהג נפוץ במיוחד בכתיבה למכשירים חיצוניים שאינם RAM, כמו GPU.


## ה-Write Combining Buffer
ה-Write Combining Buffer הוא חלק ממערכת הזיכרון, אשר מטרתו לאגד מספר כתיבות קטנות (לדוגמה, כתיבה של 8 בתים) ולשלב אותן לטרנזקציה אחת גדולה יותר (למשל שורת cache של 64 בתים) לפני שליחתה למערכת הזיכרון. הכתיבות שהיצטברו ב-buffer אינן ספקולטיביות, כלומר הן חלק מהפרוטוקול של קוהרנטיות ה-cache (כלומר הן כפופות לחוקי הפרוטוקול והן צריכות להיות קוהרנטיות). מטרת השימוש ב-write combining buffer היא לצמצם את רוחב הפס הנדרש ל-bus ולשפר את היעילות.

בדרך כלל, ה-write combining buffer משמש לצורך כתיבה שאינה ניתנת ל-cache (כתיבה שהיא uncached) למכשירי קלט/פלט, כגון כרטיסים גרפיים. במכשירי קלט/פלט, כמו כרטיסים גרפיים, יש לעיתים צורך לבצע קבוצת כתיבות לרגיסטרים של המכשיר. כתיבה זו מתבצעת בעזרת write combining buffer, אשר מאפשר לארוז את הכתיבות הקטנות לטרנזקציות גדולות יותר, ובכך לשלוח אותן בבת אחת מעבר ל-cache בצורה יעילה יותר.


## גישה לזיכרון Gathering ב-Arm


ב-ARM יש מספר מאפיינים שאפשר להגדיר לזיכרון מסוג Device, ואחד מהם הוא Gathering.
בזיכרון רגיל (זיכרון שלא מוגדר כ-Device) גישות יכולות להתבצע ב-gathering.

התכנסות (Gathering - G) או אי התכנסות (Non-Gathering - nG) קובעים אם ניתן למזג מספר גישות לזיכרון לטרנזקציה אחת עבור אזור זיכרון מסוים.

- כאשר הכתובת מסומנת כ-Non-Gathering (nG), כל גישה לכתובת זו חייבת להתאים בדיוק למספר ולגודל של הגישות המפורטות בקוד. כלומר, אין אפשרות למזג מספר גישות שונות לטרנזקציה אחת.
    
- כאשר הכתובת מסומנת כ-Gathering (G), המעבד יכול למזג מספר גישות לטרנזקציה אחת. לדוגמה, המעבד יכול למזג כתיבה של שני בתים לכתיבה אחת של חצי מילה, ובכך לייעל את ביצוע הכתיבות על ידי צמצום מספר ההעברות הדרושות.



---
%% 

https://stackoverflow.com/questions/54876208/size-of-store-buffers-on-intel-hardware-what-exactly-is-a-store-buffer
### כתיבות עוקפות cache ו-Store Buffers

כתיבות עוקפות cache (cache-bypassing stores), כגון פקודות `movnt` (לדוגמה, `movntps`), עוברות דרך ה-store buffer, כך שניתן להתייחס אליהן כספקולטיביות בדומה לכל הוראה אחרת במעבד המבצע ביצוע אוטונומי (Out-of-Order Execution - OoO). עם זאת, כתיבות אלו מתחייבות ישירות ל-Line Fill Buffer (LFB), הידוע גם כ-write-combining buffer, במקום להיכנס ל-cache L1d.

טרמינולוגיה:

- השתמשתי במונח "coalescing" כדי לתאר את תהליך המיזוג במאגר ה-store.
- השתמשתי במונח "write combining" כדי לתאר את השילוב של כתיבות NT (Non-temporal stores) ב-LFB, שמטרתו להבטיח שהכתיבות מתבצעות בצורה מאוחדת לשורת cache מלאה ללא צורך בביצוע Read For Ownership (RFO). זה דומה לתהליך המתרחש כאשר אזורי זיכרון מסוג WC (Write-Combining) מבצעים את אותו המיזוג.

 %%