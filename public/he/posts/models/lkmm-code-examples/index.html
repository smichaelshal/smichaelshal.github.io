<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <title>
  LKMM Code Examples · Michael Shalitin
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">


<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://www.youtube.com; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' default-src 'unsafe-eval' https://www.google-analytics.com https://cdn.jsdelivr.net/ https://static.cloudflareinsights.com https://cloudflareinsights.com; connect-src 'self' https://www.google-analytics.com https://static.cloudflareinsights.com https://cloudflareinsights.com;">




<meta name="author" content="Michael Shalitin">
<meta name="description" content="
  שימוש במחסומי זיכרון עם buffer-ים מעגליים
  
    
    Link to heading
  

שימוש במחסומי זיכרון בשילוב עם buffer-ים מעגליים מאפשר התמודדות עם בעיות סינכרון בצורה יעילה יותר, תוך הימנעות מהצורך במנגנונים כבדים כמו:


המנעות מנעילה: במקום להשתמש במנעול ששולט על שני הקצוות של ה-buffer (הקצה של הכתיבה והקצה של הקריאה), ניתן לאפשר גישה בו-זמנית לשני הצדדים. כך היצרן יכול להכניס נתונים ל-buffer בו זמנית עם הצרכן שמוציא נתונים ממנו, מבלי להשתמש במנעול.">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="LKMM Code Examples">
  <meta name="twitter:description" content="שימוש במחסומי זיכרון עם buffer-ים מעגליים Link to heading שימוש במחסומי זיכרון בשילוב עם buffer-ים מעגליים מאפשר התמודדות עם בעיות סינכרון בצורה יעילה יותר, תוך הימנעות מהצורך במנגנונים כבדים כמו:
המנעות מנעילה: במקום להשתמש במנעול ששולט על שני הקצוות של ה-buffer (הקצה של הכתיבה והקצה של הקריאה), ניתן לאפשר גישה בו-זמנית לשני הצדדים. כך היצרן יכול להכניס נתונים ל-buffer בו זמנית עם הצרכן שמוציא נתונים ממנו, מבלי להשתמש במנעול.">

<meta property="og:url" content="https://smichaelshal.github.io/he/posts/models/lkmm-code-examples/">
  <meta property="og:site_name" content="Michael Shalitin">
  <meta property="og:title" content="LKMM Code Examples">
  <meta property="og:description" content="שימוש במחסומי זיכרון עם buffer-ים מעגליים Link to heading שימוש במחסומי זיכרון בשילוב עם buffer-ים מעגליים מאפשר התמודדות עם בעיות סינכרון בצורה יעילה יותר, תוך הימנעות מהצורך במנגנונים כבדים כמו:
המנעות מנעילה: במקום להשתמש במנעול ששולט על שני הקצוות של ה-buffer (הקצה של הכתיבה והקצה של הקריאה), ניתן לאפשר גישה בו-זמנית לשני הצדדים. כך היצרן יכול להכניס נתונים ל-buffer בו זמנית עם הצרכן שמוציא נתונים ממנו, מבלי להשתמש במנעול.">
  <meta property="og:locale" content="he">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-12-12T00:00:00+00:00">
    <meta property="article:tag" content="Cpu">
    <meta property="article:tag" content="Memory">
    <meta property="article:tag" content="Cache">
    <meta property="article:tag" content="Ordering">
    <meta property="article:tag" content="Lkmm">
    <meta property="article:tag" content="Kernel">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/lkmm/">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/dependency/">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/herd7/">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/models/">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/base-formal/">
      <meta property="og:see_also" content="https://smichaelshal.github.io/he/posts/models/ordering/">




<link rel="canonical" href="https://smichaelshal.github.io/he/posts/models/lkmm-code-examples/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.6c967191184c40e901e41977158c33a73a2cfa2d9413cf73dddd6732eeae7af4.css" integrity="sha256-bJZxkRhMQOkB5Bl3FYwzpzos&#43;i2UE89z3d1nMu6uevQ=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://smichaelshal.github.io/he/">
      Michael Shalitin
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/he/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/he/posts/">Blog</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="/posts/models/lkmm-code-examples/">🇬🇧</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://smichaelshal.github.io/he/posts/models/lkmm-code-examples/">
              LKMM Code Examples
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2024-12-12T00:00:00Z">
                דצמבר 12, 2024
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-newspaper" aria-hidden="true"></i>
                1687 מילים
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/he/categories/memory-models/">Memory-Models</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/he/tags/cpu/">Cpu</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/memory/">Memory</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/cache/">Cache</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/ordering/">Ordering</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/lkmm/">Lkmm</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/kernel/">Kernel</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/linux/">Linux</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/barrier/">Barrier</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/memory-model/">Memory-Model</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/formal/">Formal</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/litmus/">Litmus</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/cat/">Cat</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/bell/">Bell</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/lock/">Lock</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/buffer/">Buffer</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/he/tags/release-acquire/">Release-Acquire</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="שימוש-במחסומי-זיכרון-עם-buffer-ים-מעגליים">
  שימוש במחסומי זיכרון עם buffer-ים מעגליים
  <a class="heading-link" href="#%d7%a9%d7%99%d7%9e%d7%95%d7%a9-%d7%91%d7%9e%d7%97%d7%a1%d7%95%d7%9e%d7%99-%d7%96%d7%99%d7%9b%d7%a8%d7%95%d7%9f-%d7%a2%d7%9d-buffer-%d7%99%d7%9d-%d7%9e%d7%a2%d7%92%d7%9c%d7%99%d7%99%d7%9d">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>שימוש במחסומי זיכרון בשילוב עם buffer-ים מעגליים מאפשר התמודדות עם בעיות סינכרון בצורה יעילה יותר, תוך הימנעות מהצורך במנגנונים כבדים כמו:</p>
<ul>
<li>
<p><strong>המנעות מנעילה:</strong> במקום להשתמש במנעול ששולט על שני הקצוות של ה-buffer (הקצה של הכתיבה והקצה של הקריאה), ניתן לאפשר גישה בו-זמנית לשני הצדדים. כך היצרן יכול להכניס נתונים ל-buffer בו זמנית עם הצרכן שמוציא נתונים ממנו, מבלי להשתמש במנעול.</p>
</li>
<li>
<p><strong>המנעות מ-counter אטומי:</strong> אין צורך להשתמש בפעולות מונה אטומיות לניהול מצב ה-buffer (כגון ספירת מספר הפריטים או מעקב אחרי המיקום הנוכחי לכתיבה ולקריאה).</p>
</li>
</ul>
<h3 id="חלוקת-תפקידים">
  חלוקת תפקידים
  <a class="heading-link" href="#%d7%97%d7%9c%d7%95%d7%a7%d7%aa-%d7%aa%d7%a4%d7%a7%d7%99%d7%93%d7%99%d7%9d">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>במנגנון זה ישנה הפרדה בין שני הצדדים:</p>
<ol>
<li><strong>היצרן (Producer):</strong> אחראי על מילוי ה-buffer על ידי הוספת נתונים חדשים.</li>
<li><strong>הצרכן (Consumer):</strong> אחראי על ריקון ה-buffer על ידי קריאה והוצאת הנתונים.</li>
</ol>
<h3 id="עקרונות-פעולה">
  עקרונות פעולה:
  <a class="heading-link" href="#%d7%a2%d7%a7%d7%a8%d7%95%d7%a0%d7%95%d7%aa-%d7%a4%d7%a2%d7%95%d7%9c%d7%94">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>בכל זמן נתון, בצד מסויים (היצרן או הצרכן) רק אחד יכול לפעול על ה-buffer באותו כיוון - או הוספה של נתונים או קריאה והוצאה, כלומר על מנת להשתמש במספר יצרנים או צרכנים צריך מנגנון אחד כמו נעילה.</p>
<p>עם זאת, שני הצדדים יכולים לעבוד במקביל, כלומר היצרן יכול להוסיף נתונים בזמן שהצרכן מוציא נתונים - זאת מבלי שיפריעו זה לזה.</p>
<p>שימוש במחסומי זיכרון מבטיח שסדר הפעולות יתבצע באופן שתואם את דרישות הסדר והעקיבות של הארכיטקטורה, מבלי להזדקק לפעולות סינכרון יקרות כמו נעילות או מונים אטומיים.</p>
<h3 id="ה-producer">
  ה-producer
  <a class="heading-link" href="#%d7%94-producer">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>היצרן ייראה בערך כך:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">producer_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">head</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm">/* The spin_unlock() and next spin_lock() provide needed ordering. */</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tail</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">CIRC_SPACE</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="cm">/* insert one item into the buffer */</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="k">struct</span> <span class="n">item</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="nf">produce_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="nf">smp_store_release</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">                          <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="cm">/* wake_up() will make sure that the head is committed before waking anyone up */</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="nf">wake_up</span><span class="p">(</span><span class="n">consumer</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">producer_lock</span><span class="p">);</span>
</span></span></code></pre></div><p>הפונקציה <code>wake_up()</code>  לפני שהיא מעירה תהליכים אחרים שיכולים לגשת ל-buffer, היא מבטיחה שהעדכון למשתנה <code>head</code> (או לכל משתנה אחר המייצג את נקודת ההוספה של הנתונים ב-buffer) הושלם ונכתב לזיכרון בצורה מלאה.</p>
<h4 id="סדר-כתיבה-לזיכרון-על-ידי-המעבד">
  סדר כתיבה לזיכרון על ידי המעבד
  <a class="heading-link" href="#%d7%a1%d7%93%d7%a8-%d7%9b%d7%aa%d7%99%d7%91%d7%94-%d7%9c%d7%96%d7%99%d7%9b%d7%a8%d7%95%d7%9f-%d7%a2%d7%9c-%d7%99%d7%93%d7%99-%d7%94%d7%9e%d7%a2%d7%91%d7%93">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>כאשר פריט חדש מתווסף ל-buffer המעגלי, נדרש להקפיד על סדר מסוים של פעולות כתיבה לזיכרון, כדי לשמור על עקביות וזמינות הנתונים עבור הצרכן:</p>
<ol>
<li>
<p><strong>כתיבת הפריט:</strong> המעבד מקבל הוראה לכתוב קודם כל את תוכן הפריט החדש לזיכרון. פעולה זו מבטיחה שהנתונים עצמם יהיו זמינים ומוכנים לקריאה לפני שהצרכן ינסה לגשת אליהם.</p>
</li>
<li>
<p><strong>עדכון אינדקס הראש (<code>head</code>):</strong> רק לאחר שהפריט הושלם ונכתב במלואו, המעבד מקבל הוראה לעדכן את אינדקס הראש (<code>head</code>), מה שמסמן שהפריט זמין כעת לצרכן.</p>
</li>
<li>
<p><strong>התעוררות הצרכן:</strong> בשלב האחרון, המעבד מעיר את הצרכן באמצעות קריאה ל-<code>wake_up</code>, אך רק לאחר שווידא שהאינדקס המעודכן נכתב במלואו.
חשוב לציין ש-<code>wake_up</code> אינה מספקת מחסום זיכרון אם אף תהליך אינו מתעורר בפועל. כלומר, לא ניתן להסתמך עליה בלבד כדי להבטיח סדר כתיבה תקין לזיכרון.</p>
</li>
</ol>
<h4 id="שמירה-על-אלמנט-אחד-ריק-במערך">
  שמירה על אלמנט אחד ריק במערך
  <a class="heading-link" href="#%d7%a9%d7%9e%d7%99%d7%a8%d7%94-%d7%a2%d7%9c-%d7%90%d7%9c%d7%9e%d7%a0%d7%98-%d7%90%d7%97%d7%93-%d7%a8%d7%99%d7%a7-%d7%91%d7%9e%d7%a2%d7%a8%d7%9a">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>במערך של buffer מעגלי נשמר תמיד פריט אחד ריק. מצב זה משמש כהגנה מפני השחתת נתונים במקרה של גישה מקבילה של יצרן וצרכן.</p>
<ul>
<li>
<p><strong>מגבלת ה-producer:</strong> היצרן לא יכול לכתוב ל-buffer מעבר לנקודה מסוימת עד שהצרכן מפנה אלמנטים. כדי לגרום להשחתת נתונים, היצרן יצטרך לייצר שני פריטים חדשים ולהגיע למקום שבו הצרכן עדיין קורא פריט.</p>
</li>
<li>
<p><strong>הגנת consumer:</strong> הסידור נשמר הודות למנגנון הפתיחה והנעילה שמתרחש בין הקריאות הרצופות של הצרכן.</p>
</li>
</ul>
<h4 id="תפקיד-ה-lock-ו-unlock">
  תפקיד ה-lock ו-unlock
  <a class="heading-link" href="#%d7%aa%d7%a4%d7%a7%d7%99%d7%93-%d7%94-lock-%d7%95-unlock">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>הצמד של <code>spin_unlock()</code> ו-<code>spin_lock()</code> בתהליך הצרכן מספק את הסדר הנדרש בין הפעולות:</p>
<ol>
<li>קריאת האינדקס המסמנת שהצרכן פינה אלמנט מסוים.</li>
<li>כתיבת נתון חדש על ידי היצרן באותו אלמנט.</li>
</ol>
<p>כך מובטח שהיצרן לא ידרוס נתונים שעדיין נמצאים בשימוש הצרכן, ושניהם יוכלו לעבוד במקביל תוך שמירה על עקביות זיכרון.</p>
<h3 id="ה-consumer">
  ה-Consumer
  <a class="heading-link" href="#%d7%94-consumer">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>הצרכן ייראה בערך כך:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nf">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">consumer_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm">/* Read index before reading contents at that index. */</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">head</span> <span class="o">=</span> <span class="nf">smp_load_acquire</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">CIRC_CNT</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="cm">/* extract one item from the buffer */</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="k">struct</span> <span class="n">item</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">tail</span><span class="p">];</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="nf">consume_item</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="cm">/* Finish reading descriptor before incrementing tail. */</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="nf">smp_store_release</span><span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                          <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">consumer_lock</span><span class="p">);</span>
</span></span></code></pre></div><h4 id="סדר-גישה-ל-buffer">
  סדר גישה ל-buffer
  <a class="heading-link" href="#%d7%a1%d7%93%d7%a8-%d7%92%d7%99%d7%a9%d7%94-%d7%9c-buffer">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>בעת קריאת או כתיבת נתונים ב-buffer, המעבד נדרש לבצע את הפעולות בסדר מדויק כדי להבטיח עקביות נתונים ומניעת השחתה:</p>
<ol>
<li>
<p><strong>עדכון אינדקס לפני קריאה:</strong> צריך לוודא שהאינדקס הרלוונטי (לדוגמה, אינדקס הזנב עבור קריאה) עודכן במלואו לפני ביצוע קריאה של הפריט החדש. זה מבטיח שהצרכן ייגש רק לפריטים שהוכנסו ל-buffer במלואם על ידי היצרן.</p>
</li>
<li>
<p><strong>קריאת הפריט במלואו:</strong> צריך להשלים את הקריאה של הפריט כולו לפני שיבצע עדכון של אינדקס הזנב. עדכון זה מסמן שהפריט נקרא לחלוטין וניתן למחוק אותו מה-buffer או להחליפו בפריט חדש.</p>
</li>
</ol>
<h4 id="שימוש-ב-read_once-וב-smp_load_acquire">
  שימוש ב-<code>READ_ONCE</code> וב-<code>smp_load_acquire</code>
  <a class="heading-link" href="#%d7%a9%d7%99%d7%9e%d7%95%d7%a9-%d7%91-read_once-%d7%95%d7%91-smp_load_acquire">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<ol>
<li>
<p>ה-<strong><code>READ_ONCE</code>:</strong></p>
<ul>
<li>קריאה עם <code>READ_ONCE</code> מבטיחה שהערך של האינדקס הנגדי (opposition), לדוגמה, אינדקס הראש או הזנב של הצד השני, ייקרא בדיוק פעם אחת.</li>
<li>ה-<code>READ_ONCE</code> מונע מהקומפיילר לבצע אופטימיזציות כמו השמטת קריאה או טעינה מחדש של הערך מזיכרון, מה שעלול לגרום להתנהגות לא עקבית בגישה ל-buffer.</li>
</ul>
<p>אם אתה בטוח שהאינדקס הנגדי נקרא רק פעם אחת בהקשר הנוכחי, ייתכן שלא יהיה צורך להשתמש ב-<code>READ_ONCE</code>.</p>
</li>
<li>
<p>ה-<strong><code>smp_load_acquire</code>:</strong></p>
<ul>
<li>קריאה זו מספקת שכבת הגנה נוספת בכך שהיא מאלצת את המעבד לשמור על סדר גישה לזיכרון.</li>
<li>במקרה זה, היא מבטיחה שכל פעולות הקריאה שבוצעו לפני הקריאה ל-<code>smp_load_acquire</code> הושלמו לפני גישה לערכים חדשים, כולל האינדקס הנגדי. הדבר חיוני לשמירה על עקביות בזיכרון בסביבות ריבוי-מעבדים (SMP).</li>
</ul>
</li>
</ol>
<h4 id="שימוש-ב-smp_store_release">
  שימוש ב-<code>smp_store_release</code>
  <a class="heading-link" href="#%d7%a9%d7%99%d7%9e%d7%95%d7%a9-%d7%91-smp_store_release">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>בדומה ל-<code>smp_load_acquire</code>, השימוש ב-<code>smp_store_release</code> מספק שכבת הגנה בכתיבת ערכים ל-buffer:</p>
<ol>
<li>
<p><strong>עדכון האינדקס:</strong></p>
<ul>
<li>פעולה זו מתעדת את העובדה שהאינדקס הנוכחי נכתב, כך שצד אחר במערכת (למשל, הצרכן במקרה של יצרן) יוכל לקרוא אותו בצורה בטוחה.</li>
</ul>
</li>
<li>
<p><strong>מניעת tearing:</strong></p>
<ul>
<li>ה-<code>smp_store_release</code> מונע מהקומפיילר לבצע אופטימיזציות שמפצלות את הכתיבה (tearing) או דוחות אותה, דבר שעלול להוביל למצב שבו אינדקס חלקי נחשף לצד השני לפני שהשינויים הסתיימו.</li>
</ul>
</li>
<li>
<p><strong>סדר בזיכרון:</strong></p>
<ul>
<li>פעולת ה-release מבטיחה שכל הגישות לזיכרון שבוצעו לפני הכתיבה לאינדקס תושלם לפני שהאינדקס עצמו ייכתב. כך מובטחת עקביות בין כתיבת הפריט ועדכון האינדקס.</li>
</ul>
</li>
</ol>
<h4 id="מבחן-לקמוס">
  מבחן לקמוס
  <a class="heading-link" href="#%d7%9e%d7%91%d7%97%d7%9f-%d7%9c%d7%a7%d7%9e%d7%95%d7%a1">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>המבחן הוא סוג של שילוב של התבניות LB ו-MP בהתאמה ב-2 הצדדים (גם ביצרן וגם בצרכן).</p>
<p>הרעיון כאן הוא בעצם שני thread-ים ושני דגלים בהתאמה (דגל לכל thread) ויש בנוסף משתנה buff שמייצג את ה-buffer שהוא נכתב על ידי thread היצרן ונקרא על ידי thread הצרכן.
שני הצדדים דומים ב-2 נקודות:</p>
<ul>
<li>כל צד כותב דגל וקורא דגל בהתאמה</li>
<li>כל צד צריך להיות תלוי בערך של 2 הדגלים</li>
</ul>
<p>היצרן והצרכן כמעט סמטרים חוץ משהיצרן כותב ל-buff והצרכן קורא מ-buff, אבל בגלל ההבדל הזה אז הצרכן צריך עוד מחסום כדי להתגבר על חוסר סדר בגלל שאין תלות בין load-ים ב-if בצרכן אבל לעומת זאת ביצרן יש תלות שגורמת לסדר בגלל שיש load ולאחר מכן store.</p>
<p>הערה:
יש בעיה בזמן הרצה בלהציג את הצורך כאן ב-<code>smp_store_release</code> בצרכן בגלל שאין במבחן עצמו (בקוד האמיתי יש) באמת תלות אמיתית בסדר שה-<code>smp_store_release</code> יוצר ולכן גם אם כאן נחליף אותו ב-<code>WRITE_ONCE</code> אז המבחן יראה שאין בעיות למרות שכן יש צורך בו.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln"> 1</span><span class="cl">
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">C</span> <span class="n">circular</span><span class="o">-</span><span class="n">buffer</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	<span class="kt">int</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">	<span class="kt">int</span> <span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">	<span class="kt">int</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nf">P0</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tail</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span> <span class="c1">// producer
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">	<span class="kt">int</span> <span class="n">r0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">	<span class="kt">int</span> <span class="n">r1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">	
</span></span><span class="line"><span class="ln">15</span><span class="cl">	<span class="n">r0</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">);</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span>	<span class="n">r1</span> <span class="o">=</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">		<span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">		<span class="nf">smp_store_release</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="n">r1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="nf">P1</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tail</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buff</span><span class="p">)</span> <span class="c1">// consumer
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">	<span class="kt">int</span> <span class="n">r2</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">	<span class="kt">int</span> <span class="n">r3</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">	<span class="kt">int</span> <span class="n">r4</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">	
</span></span><span class="line"><span class="ln">29</span><span class="cl">	<span class="n">r2</span> <span class="o">=</span> <span class="nf">smp_load_acquire</span><span class="p">(</span><span class="n">head</span><span class="p">);</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="c1"></span>	<span class="n">r3</span> <span class="o">=</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span>	<span class="k">if</span><span class="p">(</span><span class="n">r2</span> <span class="o">+</span> <span class="n">r3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">		<span class="n">r4</span> <span class="o">=</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span> <span class="c1">// 1 (Shouldn&#39;t happen)
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="c1"></span>		<span class="nf">smp_store_release</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span> <span class="n">r3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="c1">// (* exists (0:r0=1 /\ 0:r1=1 /\ 1:r2=2 /\ 1:r3=1 /\ 1:r4=1) *)
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="c1"></span><span class="nf">exists</span> <span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="n">r2</span><span class="o">=</span><span class="mi">2</span> <span class="o">/</span><span class="err">\</span> <span class="mi">1</span><span class="o">:</span><span class="n">r4</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><hr>
<h2 id="דוגמאות-בקרנל">
  דוגמאות בקרנל
  <a class="heading-link" href="#%d7%93%d7%95%d7%92%d7%9e%d7%90%d7%95%d7%aa-%d7%91%d7%a7%d7%a8%d7%a0%d7%9c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="דוגמה-לתבנית-mp-בקרנל">
  דוגמה לתבנית MP בקרנל
  <a class="heading-link" href="#%d7%93%d7%95%d7%92%d7%9e%d7%94-%d7%9c%d7%aa%d7%91%d7%a0%d7%99%d7%aa-mp-%d7%91%d7%a7%d7%a8%d7%a0%d7%9c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>דוגמה די פשוטה בקרנל לתבנית MP  אפשר למצוא בהרבה מקומות.</p>
<p>בפונקציה <code>fsnotify_add_mark_list</code> בקובץ <code>fs/notify/mark.c</code> אפשר לראות (גם מגיע עם הסבר בהערות) שהפונקציה היא צד ה-producer ויש כתיבה של ערך חדש ולאחר מכן מדליקים דגל שמסמן ל-consumer שהנתונים נכתבו.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsid</span> <span class="o">=</span> <span class="o">*</span><span class="n">fsid</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cm">/* Pairs with smp_rmb() in fanotify_get_fsid() */</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nf">smp_wmb</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FSNOTIFY_CONN_FLAG_HAS_FSID</span><span class="p">;</span>
</span></span></code></pre></div><p>זה נעשה על ידי:</p>
<ol>
<li>הכתיבה של המידע עצמו ל-<code>conn-&gt;fsid</code></li>
<li>לאחר מכן מוסיפים מחסום כתיבה <code>wmb</code></li>
<li>ולבסוף כותבים ל-<code>conn-&gt;flags</code>.</li>
</ol>
<p>בצד ה-consumer שנמצא בפונקציה <code>fanotify_get_fsid</code> בקובץ <code>fs/notify/fanotify/fanotify.c</code> גם פשוט:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">mark</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cm">/* Mark is just getting destroyed or created? */</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">	<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FSNOTIFY_CONN_FLAG_HAS_FSID</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">	<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="cm">/* Pairs with smp_wmb() in fsnotify_add_mark_list() */</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="nf">smp_rmb</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="n">fsid</span> <span class="o">=</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">fsid</span><span class="p">;</span>
</span></span></code></pre></div><p>כאן דבר ראשון מבצעים קריאה של <code>mark-&gt;connector</code> ובודקים אם הוא קיים ואם הדגל <code>FSNOTIFY_CONN_FLAG_HAS_FSID</code> דלוק (שאת הדגל הזה מדליקים ב-producer) ואם כן אז מבצעים קריאה של <code>conn-&gt;fsid</code>.</p>
<p>במקרה הזה ובכללי ב-MP יש צורך במחסומים כדי שלא יקרה מצב שה-consumer ינסה לקרוא מידע לפני שהוא נכתב על ידי ה-producer וזה מצריך מחסומים ב-consumer וגם ב-producer כי כל אחד מהם יכול לבצע את ההוראות שלו בצורה out-of-order.</p>
<h3 id="דוגמה-לתבנית-sb-בקרנל">
  דוגמה לתבנית SB בקרנל
  <a class="heading-link" href="#%d7%93%d7%95%d7%92%d7%9e%d7%94-%d7%9c%d7%aa%d7%91%d7%a0%d7%99%d7%aa-sb-%d7%91%d7%a7%d7%a8%d7%a0%d7%9c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>בתבנית SB כל צד הוא גם כותב וגם קורא, וכל צד קורא את המידע שהצד השני כתב.
דוגמה לתבנית היא בקובץ <code>fs/fuse/dev.c</code> בפונקציות <code>request_wait_answer</code> ו-<code>fuse_dev_do_read</code>.</p>
<p>בפונקציות האלה כל צד מדליק ביט בשדה בדגל ולאחר מכן בודק אם ביט אחר דלוק בדגל והביט הזה נדלק על ידי הצד השני.</p>
<p>הפונקציה <code>request_wait_answer</code>:
<a href="https://elixir.bootlin.com/linux/v6.4.11/source/fs/fuse/dev.c#L364"  class="external-link" target="_blank" rel="noopener">קישור</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="nf">set_bit</span><span class="p">(</span><span class="n">FR_INTERRUPTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="cm">/* matches barrier in fuse_dev_do_read() */</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nf">smp_mb__after_atomic</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">FR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">	<span class="p">...</span>
</span></span></code></pre></div><p>בהתחלה נעשית כתיבה ל-<code>req-&gt;flags</code> בביט במיקום <code>FR_INTERRUPTED</code> על ידי הפעולה האטומית <code>set_bit</code> ולמרות שהיא אטומית היא לא מרמזת על מחסום ולכן צריך להוסיף לה מחסום, בגלל שאנחנו רוצים סדר בין כתיבה לקריאה אנחנו צריכים מחסום חזק אחרי הפעולה האטומית והמחסום המתאים לזה הוא <code>smp_mb__after_atomic</code>.
לאחר המחסום יש קריאה על הדגל <code>req-&gt;flags</code>  בביט במיקום <code>FR_SENT</code>.</p>
<p>כאן יש משהו שנראה קצת מוזר, למה צריך להוסיף מחסום אם גם הכתיבה וגם הקריאה נעשים על אותו משתנה (<code>req-&gt;flags</code>), לרוב אנחנו מצפים שמדובר על אותו משתנה אז גם אם יש כתיבה ואחריה קריאה באותו thread הקריאה תסופק מערך חדש לפחות כמו הכתיבה, זה יכול לקרות בגלל שזה אותו משתנה אבל לא בדיוק אותה כתובת (ה-offset של הביטים שונה בתוך הדגל) אז יכול להיות כאן סידור מחדש.</p>
<p>הפונקציה <code>fuse_dev_do_read</code>:
<a href="https://elixir.bootlin.com/linux/v6.4.11/source/fs/fuse/dev.c#L1204"  class="external-link" target="_blank" rel="noopener">קישור</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="ln">1</span><span class="cl"><span class="nf">set_bit</span><span class="p">(</span><span class="n">FR_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="cm">/* matches barrier in request_wait_answer() */</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="nf">smp_mb__after_atomic</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">FR_INTERRUPTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">	<span class="p">...</span>
</span></span></code></pre></div><p>גם כאן אנחנו רואים את אותם הדברים שהיו ב-<code>request_wait_answer</code> רק שהמשתנים הפוכים, כלומר יש כתיבה לדגל בביט במיקום <code>FR_SENT</code> ולאחר מכן מחסום ואחריו קריאה מהדגל בביט במיקום <code>FR_INTERRUPTED</code>.</p>

      </div>


      <footer>
        
  <h3 dir="rtl">
    מקורות
  </h3>
  <ul dir="ltr">
  
    <li>
      <a href="https://docs.kernel.org/core-api/circular-buffers.html">https://docs.kernel.org/core-api/circular-buffers.html</a>
    </li>
  
    <li>
      <a href="https://www.kernel.org/doc/html/v5.1/core-api/atomic_ops.html#atomic-bitmask">https://www.kernel.org/doc/html/v5.1/core-api/atomic_ops.html#atomic-bitmask</a>
    </li>
  
    <li>
      <a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt">https://www.kernel.org/doc/Documentation/memory-barriers.txt</a>
    </li>
  

        

<section class="see-also">
  
    
    
    
      <h3 id="רואה-עוד-ב-memory-models" dir="rtl">        רואה עוד ב memory-models
        <a class="heading-link" href="#%d7%a8%d7%95%d7%90%d7%94-%d7%a2%d7%95%d7%93-%d7%91-memory-models">
          <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
          <span class="sr-only">Link to heading</span>
        </a>
      </h3>
      <nav>
        <ul>
        
        
          
        
          
            <li>
              <a href="/he/posts/models/lkmm/">LKMM</a>
            </li>
          
        
          
            <li>
              <a href="/he/posts/models/dependency/">Dependency</a>
            </li>
          
        
          
            <li>
              <a href="/he/posts/models/herd7/">Herd7</a>
            </li>
          
        
          
            <li>
              <a href="/he/posts/models/models/">Models</a>
            </li>
          
        
          
            <li>
              <a href="/he/posts/models/base-formal/">Base Formal</a>
            </li>
          
        
        </ul>
      </nav>
    
  
</section>


        
        
        
        
        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script><style>
  .katex {
    direction: ltr;
    display: inline-flex;
    flex-direction: row-reverse;
    unicode-bidi: embed;
  }
</style>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     Michael Shalitin 
    ·
    
    מופעל על ידי <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  
<script defer src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "316bf5f2576c4cb68b54c0b2a91cb739"}'></script>



  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
